<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>PLAYERMPD</title>

  <!-- Shaka UI v4.1.1 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.1.1/controls.min.css" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Sharp" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://kltraid.pages.dev/css/playermpd.css">
  <meta name="referrer" content="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.1.1/shaka-player.ui.min.js" crossorigin="anonymous"></script>

  <style>
    /* === paste seluruh CSS yang kamu kirim di sini === */
  </style>
</head>
<body>
  <button id="pageShareBtn" class="page-share-btn" title="Copy embed">
    <i class="material-icons-sharp" aria-hidden="true">ios_share</i>
  </button>
  <div id="copyToast" class="copy-toast">Embed code copied</div>

  <div data-shaka-player-container shaka-controls="true" class="shaka-video-container youtube-theme" style="width:100%;height:100%;cursor:none;">
    <video autoplay muted playsinline webkit-playsinline data-shaka-player id="video" class="shaka-video"></video>
  </div>

  <script>
  // ===== CONFIG SINGLE MANIFEST =====
  const manifestUrl = "https://otte.live.fly.ww.aiv-cdn.net/lhr-nitro/live/clients/dash/enc/wf8usag51e/out/v1/bd3b0c314fff4bb1ab4693358f3cd2d3/cenc.mpd";
  const drmKeys = {
    "ae26845bd33038a9c0774a0981007294": "63ac662dde310cfb4cc6f9b43b34196d"
  };
  let currentChannelUrl = manifestUrl;

  // ===== PRELOAD MPD =====
  function injectPreload(url) {
    try {
      const link = document.createElement('link');
      link.rel = 'preload';
      link.as = 'fetch';
      link.href = url;
      link.crossOrigin = 'anonymous';
      link.referrerPolicy = 'no-referrer';
      document.head.appendChild(link);
      fetch(url, { cache: 'reload' }).catch(()=>{});
      console.log("Preload injected:", url);
    } catch(e){ console.warn("Preload inject fail:", e); }
  }

  // ===== REFRESH BUTTON =====
  if (!window.__refreshRegistered) {
    class RefreshButton extends shaka.ui.Element {
      constructor(parent, controls) {
        super(parent, controls);
        this.player_ = controls.getPlayer();
        this.btn_ = document.createElement('button');
        this.btn_.classList.add('shaka-button','shaka-refresh-button');
        this.btn_.setAttribute('aria-label','Refresh Stream');
        this.btn_.setAttribute('title','Refresh Stream');
        this.btn_.innerHTML = '<span class="material-icons-sharp" aria-hidden="true">refresh</span>';
        parent.appendChild(this.btn_);
        this.eventManager.listen(this.btn_, 'click', async () => {
          try {
            this.btn_.disabled = true;
            await this.player_.load(currentChannelUrl);
          } catch(e){ console.error("Refresh failed:",e); }
          finally { this.btn_.disabled = false; }
        });
      }
      release(){ this.btn_?.remove(); this.btn_=null; super.release(); }
    }
    RefreshButton.Factory = class { create(root,controls){ return new RefreshButton(root,controls);} };
    shaka.ui.Controls.registerElement('refresh', new RefreshButton.Factory());
    window.__refreshRegistered = true;
  }

  // ===== INIT PLAYER =====
  let __initCalled=false;
  async function init(){
    if(__initCalled) return;
    __initCalled=true;
    const video=document.getElementById('video');
    const ui=video['ui'];
    const controls=ui.getControls();
    const player=controls.getPlayer();
    window.player=player;
    window.ui=ui;

    player.addEventListener('error', e=>onPlayerError(e.detail));
    controls.addEventListener('error', e=>onPlayerError(e.detail));

    injectPreload(manifestUrl);

    player.configure({
      drm:{ clearKeys: drmKeys },
      streaming:{
        lowLatencyMode:true,
        rebufferingGoal:2.5,
        bufferingGoal:12,
        smallGapLimit:0.5,
        stallEnabled:true,
        stallThreshold:0.25,
        retryParameters:{ timeout:4000, maxAttempts:2, baseDelay:250 }
      },
      abr:{
        enabled:true,
        defaultBandwidthEstimate:5_000_000,
        restrictions:{ minBandwidth:1_000_000, maxBandwidth:6_000_000 },
        switchInterval:2
      },
      manifest:{ dash:{ ignoreMinBufferTime:true, autoCorrectDrift:true } }
    });

    try {
      await player.load(manifestUrl);
      video.addEventListener("play", ()=>{
        setTimeout(()=>{ 
          player.configure({ abr:{ restrictions:{ minBandwidth:1_000_000, maxBandwidth:Infinity }}});
          console.log("ABR booster: bitrate limit removed");
        },10000);
      },{once:true});
      mountBigUnmute();
    } catch(err){ onPlayerError(err); }

    document.addEventListener('fullscreenchange',()=>{
      if(document.fullscreenElement) lockOrientationToLandscape();
    });

    ui.configure({
      controlPanelElements:['play_pause','spacer','mute','refresh','fullscreen','overflow_menu'],
      seekBarColors:{
        base:'rgba(255,0,0,0.3)',
        buffered:'rgba(255,0,0,0.5)',
        played:'red',
        adBreaks:'yellow'
      }
    });
  }

  function onPlayerError(err){ console.error("Error code",err.code,"object",err); }
  function lockOrientationToLandscape(){
    if(screen.orientation?.lock){
      screen.orientation.lock('landscape').catch(e=>console.warn("Orientation lock failed:",e));
    }
  }

  // ===== SHARE EMBED =====
  function buildEmbedCode(srcUrl){
    return `<iframe src="${srcUrl}" width="100%" height="100%" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen loading="lazy"></iframe>`;
  }
  async function copyText(text){
    try{ await navigator.clipboard.writeText(text); return true; }
    catch{ const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); return true; }
  }
  function showToast(msg){
    const el=document.getElementById('copyToast'); if(!el) return;
    el.textContent=msg; el.style.display='block';
    clearTimeout(showToast._t); showToast._t=setTimeout(()=>{ el.style.display='none'; },1500);
  }
  document.getElementById('pageShareBtn')?.addEventListener('click', async()=>{
    if(await copyText(buildEmbedCode(location.href))) showToast("Embed code copied");
  });

  // ===== BIG UNMUTE =====
  function mountBigUnmute(){
    const container=document.querySelector('.shaka-video-container.youtube-theme');
    const playerVideo=document.querySelector('video[data-shaka-player]');
    if(!container||!playerVideo) return;
    if(container.querySelector('.player-unmute')) return;
    const btn=document.createElement('button');
    btn.className='player-unmute';
    btn.innerHTML='<span class="mi">volume_off</span><span>Unmute</span>';
    container.appendChild(btn);
    btn.addEventListener('click',async()=>{
      try{
        playerVideo.muted=false;
        if(window.player?.setVolume){
          const vol=window.player.getVolume?.()??0.8;
          window.player.setVolume(Math.max(vol,0.5));
        } else if(playerVideo.volume===0){ playerVideo.volume=0.8; }
        await playerVideo.play().catch(()=>{});
      } finally { update(); }
    });
    playerVideo.addEventListener('volumechange', update);
    update();
    function update(){
      if(playerVideo.muted||playerVideo.volume===0){
        btn.style.display='inline-flex'; btn.querySelector('.mi').textContent='volume_off'; btn.lastElementChild.textContent='Unmute';
      } else { btn.style.display='none'; }
    }
  }

  // ===== HOOK SHAKA =====
  document.addEventListener('shaka-ui-loaded',init);
  document.addEventListener('shaka-ui-load-failed',()=>console.error("UI load failed"));
  document.addEventListener('DOMContentLoaded',()=>{ const v=document.getElementById('video'); if(v?.['ui']) init(); });
  </script>
</body>
</html>
